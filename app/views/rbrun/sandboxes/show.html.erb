<%= turbo_stream_from @sandbox %>

<div class="flex-1 min-h-0 flex overflow-hidden">
  <%# LEFT COLUMN %>
  <div class="<%= @sandbox.exposed? && @sandbox.preview_url.present? ? 'w-1/3' : 'w-full' %> flex flex-col min-h-0 overflow-hidden">
    <%# Header %>
    <div class="flex-shrink-0 p-4 border-b">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <%= link_to "â† Sandboxes", sandboxes_path, class: "text-blue-600 hover:underline" %>
          <span class="text-gray-400">|</span>
          <span class="font-mono"><%= @sandbox.slug %></span>
          <span class="px-2 py-1 text-xs rounded <%= sandbox_state_class(@sandbox) %>">
            <%= @sandbox.state %>
          </span>
        </div>

        <div class="flex items-center gap-2">
          <% if Rbrun.configuration.cloudflare_configured? %>
            <%= button_to @sandbox.exposed? ? "Public" : "Private",
                  toggle_expose_sandbox_path(@sandbox),
                  method: :post,
                  class: "px-3 py-1 text-sm border rounded hover:bg-gray-50" %>
          <% end %>

          <% unless @sandbox.stopped? %>
            <%= button_to "Stop",
                  sandbox_path(@sandbox),
                  method: :delete,
                  class: "px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700",
                  data: { turbo_confirm: "Are you sure you want to stop this sandbox?" } %>
          <% end %>
        </div>
      </div>

      <% if @sandbox.last_error.present? %>
        <div class="mt-2 p-2 bg-red-100 text-red-700 text-sm rounded">
          <%= @sandbox.last_error %>
        </div>
      <% end %>

      <% if @sandbox.running? && @sandbox.preview_url.present? %>
        <div class="mt-2 text-sm">
          Preview: <%= link_to @sandbox.preview_url, @sandbox.preview_url, target: "_blank", class: "text-blue-600 hover:underline" %>
        </div>
      <% end %>
    </div>

    <%# Output Logs with Infinite Scroll %>
    <div class="flex-1 min-h-0 flex flex-col p-4 bg-gray-900 overflow-hidden"
         data-controller="rbrun--infinite-scroll"
         data-rbrun--infinite-scroll-url-value="<%= sandbox_logs_path(@sandbox) %>"
         data-rbrun--infinite-scroll-oldest-id-value="<%= @logs.first&.id %>">

      <div class="flex-1 min-h-0 overflow-y-auto font-mono text-sm text-gray-100 whitespace-pre-wrap"
           data-rbrun--infinite-scroll-target="logs">

        <div data-rbrun--infinite-scroll-target="sentinel"></div>

        <div id="<%= dom_id(@sandbox, :output_logs) %>">
          <%= render "rbrun/logs/log_lines", logs: @logs %>
        </div>
      </div>
    </div>
  </div>

  <%# RIGHT COLUMN (only if exposed) %>
  <% if @sandbox.exposed? && @sandbox.preview_url.present? %>
    <div class="w-2/3 flex flex-col min-h-0 overflow-hidden border-l">
      <div class="flex-shrink-0 p-2 border-b bg-gray-50">
        <div class="flex items-center justify-between">
          <span class="text-sm font-mono"><%= @sandbox.preview_url %></span>
          <%= link_to "Open", @sandbox.preview_url, target: "_blank", class: "text-sm text-blue-600 hover:underline" %>
        </div>
      </div>
      <iframe src="<%= @sandbox.preview_url %>" class="flex-1 min-h-0 w-full"></iframe>
    </div>
  <% end %>
</div>
